<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LinPlayer TV · 添加服务器</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .card { max-width: 860px; margin: 0 auto; padding: 16px; border: 1px solid rgba(127,127,127,0.35); border-radius: 12px; background: rgba(127,127,127,0.06); }
    h1 { font-size: 18px; margin: 0 0 8px 0; }
    .muted { opacity: 0.75; font-size: 12px; }
    label { display: block; margin: 10px 0 6px; font-size: 13px; }
    input, select, textarea, button { width: 100%; padding: 10px; font-size: 16px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); box-sizing: border-box; background: transparent; color: inherit; }
    button { margin-top: 12px; cursor: pointer; }
    pre { white-space: pre-wrap; word-break: break-word; font-size: 12px; opacity: 0.85; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    details { margin-top: 14px; }
    summary { cursor: pointer; font-weight: 700; }
    .hint { font-size: 12px; opacity: 0.8; margin-top: 6px; }
    .lines { margin-top: 10px; }
    .line { display: grid; grid-template-columns: 22px 22px 1fr; gap: 10px; align-items: start; padding: 6px 0; border-bottom: 1px solid rgba(127,127,127,0.18); }
    .line:last-child { border-bottom: 0; }
    .line small { display: block; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="card">
    <h1>LinPlayer · TV 添加服务器</h1>
    <div class="muted" id="info">正在连接…</div>

    <hr style="opacity:0.25; margin: 14px 0;" />

    <form id="addServerForm">
      <label>类型</label>
      <select id="type">
        <option value="emby">Emby</option>
        <option value="jellyfin">Jellyfin</option>
        <option value="webdav">WebDAV</option>
      </select>

      <label>地址（host/path 或完整 URL）</label>
      <input id="baseUrl" placeholder="例如：https://example.com 或 192.168.1.2:8096 或 192.168.1.2/dav" autocomplete="off" />

      <div class="row">
        <div>
          <label>Scheme（如未写在地址里）</label>
          <select id="scheme">
            <option value="https" selected>https</option>
            <option value="http">http</option>
          </select>
        </div>
        <div>
          <label>端口（可选）</label>
          <input id="port" placeholder="例如：8096" inputmode="numeric" autocomplete="off" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>账号（Emby/Jellyfin/WebDAV）</label>
          <input id="username" autocomplete="username" />
        </div>
        <div>
          <label>密码</label>
          <input id="password" type="password" autocomplete="current-password" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>显示名（可选）</label>
          <input id="displayName" autocomplete="off" />
        </div>
        <div>
          <label>备注（可选）</label>
          <input id="remark" autocomplete="off" />
        </div>
      </div>

      <label>图标 URL（可选）</label>
      <input id="iconUrl" placeholder="例如：https://example.com/favicon.ico" autocomplete="off" />

      <details>
        <summary>从分享文本解析线路（可选，参考“批量解析”）</summary>
        <div class="hint">粘贴包含「线路」「用户密码」「端口」等内容的分享文本，解析后可一键填充地址，并把其它已选线路作为备用域名。</div>
        <label>分享文本</label>
        <textarea id="shareText" rows="6" placeholder="粘贴分享内容（支持多行）"></textarea>
        <button id="parseShareTextBtn" type="button">解析分享文本</button>
        <div id="shareParseUi" class="lines"></div>
      </details>

      <label style="display:flex; align-items:center; gap:10px; margin-top: 12px;">
        <input id="activate" type="checkbox" checked style="width: 20px; height: 20px; margin: 0;" />
        添加后设为当前服务器
      </label>

      <button type="submit">添加到 TV</button>
    </form>

    <pre id="log"></pre>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const token = params.get('token') || '';
    const logEl = document.getElementById('log');
    const infoEl = document.getElementById('info');
    const log = (s) => { logEl.textContent = (new Date().toLocaleTimeString()) + ' ' + s + '\n' + logEl.textContent; };

    const api = async (path, body) => {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(body),
      });
      return await res.json();
    };

    const shareTextEl = document.getElementById('shareText');
    const parseShareTextBtn = document.getElementById('parseShareTextBtn');
    const shareParseUi = document.getElementById('shareParseUi');

    let parsedGroups = [];
    let selectedGroupIndex = 0;

    const safeText = (s) => (s == null ? '' : String(s));

    const pickSuggestedPrimary = (group) => {
      const lines = (group && group.lines) ? group.lines : [];
      return lines.find((l) => l && l.selectedByDefault) || lines[0] || null;
    };

    const groupLabel = (group, index) => {
      const primary = pickSuggestedPrimary(group);
      if (!primary) return `服务器 ${index + 1}`;
      try {
        const u = new URL(primary.url);
        return u.host || primary.name || `服务器 ${index + 1}`;
      } catch (_) {
        return primary.name || primary.url || `服务器 ${index + 1}`;
      }
    };

    const renderShareParseUi = () => {
      shareParseUi.innerHTML = '';
      if (!parsedGroups.length) return;

      const groupSel = document.createElement('select');
      groupSel.id = 'parsedGroupSelect';
      parsedGroups.forEach((g, i) => {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = groupLabel(g, i);
        groupSel.appendChild(opt);
      });
      groupSel.value = String(selectedGroupIndex);
      groupSel.addEventListener('change', () => {
        selectedGroupIndex = Number(groupSel.value) || 0;
        renderShareParseUi();
      });
      shareParseUi.appendChild(groupSel);

      const group = parsedGroups[selectedGroupIndex] || {};
      const lines = Array.isArray(group.lines) ? group.lines : [];
      const pw = safeText(group.password).trim();

      const meta = document.createElement('div');
      meta.className = 'hint';
      meta.textContent = pw ? `已识别到密码（可直接用作登录密码）：${pw}` : '未识别到密码（可手动填写）。';
      shareParseUi.appendChild(meta);

      if (!lines.length) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = '未解析到线路。';
        shareParseUi.appendChild(empty);
        return;
      }

      // Default primary: first selected line, otherwise the first line.
      const suggestedPrimary = pickSuggestedPrimary(group) || lines[0];
      const primaryDefaultUrl = suggestedPrimary ? safeText(suggestedPrimary.url) : safeText(lines[0].url);

      const list = document.createElement('div');
      list.className = 'lines';

      lines.forEach((l, idx) => {
        const url = safeText(l.url).trim();
        const name = safeText(l.name).trim();
        const checked = !!l.selectedByDefault;

        const row = document.createElement('div');
        row.className = 'line';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `line_cb_${idx}`;
        cb.checked = checked;
        cb.dataset.url = url;
        cb.dataset.name = name;

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'primary_line';
        radio.id = `line_primary_${idx}`;
        radio.value = url;
        radio.checked = url === primaryDefaultUrl;

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.textContent = name || url;
        if (name && url && name !== url) {
          const small = document.createElement('small');
          small.textContent = url;
          label.appendChild(small);
        }

        row.appendChild(cb);
        row.appendChild(radio);
        row.appendChild(label);
        list.appendChild(row);
      });

      shareParseUi.appendChild(list);

      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.textContent = '使用解析结果填充地址/密码';
      applyBtn.addEventListener('click', () => {
        const { primaryUrl, passwordText } = collectParsedSelection();
        if (primaryUrl) document.getElementById('baseUrl').value = primaryUrl;
        if (passwordText && !document.getElementById('password').value.trim()) {
          document.getElementById('password').value = passwordText;
        }
        log(primaryUrl ? '已填充地址' : '未选择线路，无法填充地址');
      });
      shareParseUi.appendChild(applyBtn);
    };

    const collectParsedSelection = () => {
      if (!parsedGroups.length) return { primaryUrl: '', customDomains: [], passwordText: '' };
      const group = parsedGroups[selectedGroupIndex] || {};
      const passwordText = safeText(group.password).trim();

      const checkboxes = Array.from(shareParseUi.querySelectorAll('input[type="checkbox"][data-url]'));
      const selected = checkboxes.filter((cb) => cb.checked).map((cb) => ({
        name: cb.dataset.name || '',
        url: cb.dataset.url || '',
      })).filter((e) => e.url && e.url.trim());

      const primaryRadio = shareParseUi.querySelector('input[type="radio"][name="primary_line"]:checked');
      let primaryUrl = primaryRadio ? safeText(primaryRadio.value).trim() : '';
      if (primaryUrl && !selected.some((e) => e.url === primaryUrl)) {
        primaryUrl = '';
      }
      if (!primaryUrl && selected.length) {
        primaryUrl = selected[0].url;
      }

      const customDomains = selected
        .filter((e) => e.url !== primaryUrl)
        .map((e) => ({ name: e.name || e.url, url: e.url }));

      return { primaryUrl, customDomains, passwordText };
    };

    parseShareTextBtn.addEventListener('click', async () => {
      if (!token) { log('缺少 token'); return; }
      const text = (shareTextEl.value || '').trim();
      if (!text) { log('分享文本为空'); return; }

      log('解析中…');
      try {
        const data = await api('/api/parseShareText', { token, text });
        if (!data.ok) throw new Error(data.error || 'unknown');
        parsedGroups = Array.isArray(data.groups) ? data.groups : [];
        selectedGroupIndex = 0;
        if (!parsedGroups.length) {
          shareParseUi.innerHTML = '<div class="hint">未解析到服务器地址。</div>';
          log('未解析到服务器地址');
          return;
        }
        renderShareParseUi();
        log(`解析完成：${parsedGroups.length} 组`);
      } catch (e) {
        log('解析失败：' + e);
      }
    });

    const loadInfo = async () => {
      if (!token) {
        infoEl.textContent = '缺少 token：请重新扫码打开。';
        return;
      }
      try {
        const res = await fetch('/api/info?token=' + encodeURIComponent(token), { cache: 'no-store' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'unknown');
        const app = data.app || {};
        const server = data.server || {};
        infoEl.textContent = `${app.name || 'LinPlayer'} ${app.version || ''}` +
          (server.activeServerName ? ` · 当前：${server.activeServerName}` : '');
      } catch (e) {
        infoEl.textContent = '连接失败：' + e;
      }
    };
    loadInfo();

    document.getElementById('addServerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!token) { log('缺少 token'); return; }

      const parsedSelection = collectParsedSelection();
      if (!document.getElementById('baseUrl').value.trim() && parsedSelection.primaryUrl) {
        document.getElementById('baseUrl').value = parsedSelection.primaryUrl;
      }
      if (!document.getElementById('password').value.trim() && parsedSelection.passwordText) {
        document.getElementById('password').value = parsedSelection.passwordText;
      }

      const payload = {
        token,
        type: document.getElementById('type').value,
        baseUrl: document.getElementById('baseUrl').value,
        scheme: document.getElementById('scheme').value,
        port: document.getElementById('port').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        displayName: document.getElementById('displayName').value,
        remark: document.getElementById('remark').value,
        iconUrl: document.getElementById('iconUrl').value,
        activate: document.getElementById('activate').checked,
        customDomains: parsedSelection.customDomains,
      };

      log('提交中…');
      try {
        const data = await api('/api/addServer', payload);
        if (!data.ok) throw new Error(data.error || 'unknown');
        log('成功：已添加到 TV');
      } catch (e) {
        log('失败：' + e);
      }
    });
  </script>
</body>
</html>
